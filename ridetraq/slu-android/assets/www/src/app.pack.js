$(window).resize(function(){if(RTApp.views&&RTApp.views.mapView&&RTApp.views.mapView.map){RTApp.fixHeight($("#map"));google.maps.event.trigger(RTApp.views.mapView.map,"resize")}});$(document).click(function(c){var b=c.target;var a=$(b).closest(".ui-btn");$activeClickedLink=a.not(".ui-disabled").not(".menu");$activeClickedLink.addClass($.mobile.activeBtnClass);if(!a.hasClass("no-deselect")){setTimeout(function(){$activeClickedLink.removeClass($.mobile.activeBtnClass)},200)}return true});$(document).ready(function(){RTApp.load();RTApp.dialogs.common=new Dialog("#commonDialog");RTApp.dialogs.routeInfo=new Dialog("#routeInfo")});RTApp={};RTApp.cache=true;RTApp.clearAndReload=function(){LocalStorageManager.clear();window.location.reload()};RTApp.C_LOCALSTORAGE_CLIENT_ID="RTApp.C_LOCALSTORAGE_CLIENT_ID______________";RTApp.C_LOCALSTORAGE_CACHE_4_GET_CLIENTS="C_LOCALSTORAGE_CAHCE_4_GET_CLIENTS__________"+((!RTApp.cache)?Math.random():"");RTApp.C_LOCALSTORAGE_CACHE_4_GET_ROUTES="C_LOCALSTORAGE_CACHE_4_GET_ROUTES___________"+((!RTApp.cache)?Math.random():"");RTApp.C_LOCALSTORAGE_CACHE_4_GET_STOPS="C_LOCALSTORAGE_CACHE_4_GET_STOPS____________"+((!RTApp.cache)?Math.random():"");RTApp.C_LOCALSTORAGE_CACHE_4_GET_CLIENT_SETTINGS="C_LOCALSTORAGE_CACHE_4_GET_CLIENT_SETTINGS__"+((!RTApp.cache)?Math.random():"");RTApp.C_LOCALSTORAGE_CACHE_4_GET_ROUTE_SCHEDULES="C_LOCALSTORAGE_CACHE_4_GET_ROUTE_SCHEDULES__"+((!RTApp.cache)?Math.random():"");RTApp.cfg={};RTApp.cfg.useLocalStorageCache=(typeof(localStorage)!="undefined");RTApp.cfg.BUS_REFRESH_TIME=3*1000;RTApp.cfg.TWITTS_PER_PAGE=5;RTApp.cfg.urls={};RTApp.cfg.urls.GET_CLIENTS_URL="http://www.ridesystems.net/RideAdmin/Services/MobileClientService.svc/JSON/GetClients";RTApp.cfg.urls.GET_STOPS_URL="http://{WebAddress}/Services/JSONPRelay.svc/GetStops";RTApp.cfg.urls.GET_ROUTES_URL="http://{WebAddress}/Services/JSONPRelay.svc/GetRoutes";RTApp.cfg.urls.GET_ROUTE_URL="http://{WebAddress}/dev/services/Jsonprelay.svc/GetRoutes";RTApp.cfg.urls.GET_BUSES_URL="http://{WebAddress}/Services/JSONPRelay.svc/GetMapVehiclePoints";RTApp.cfg.urls.GET_CLIENT_SETTINGS="http://{WebAddress}/services/Jsonprelay.svc/GetClientSettings";RTApp.cfg.urls.GET_ESTIMATES_URL="http://{WebAddress}/Services/JSONPRelay.svc/GetMapStopEstimates?RouteID={RouteID}";RTApp.cfg.urls.GET_ROUTE_SCHEDULES="http://{WebAddress}/Services/JSONPRelay.svc/GetRouteSchedules";RTApp.cfg.urls.TWITTER_URL="https://twitter.com/status/user_timeline/{q}.json?count={rpp}";RTApp.currentState={};RTApp.currentState.client=null;RTApp.currentState.route=null;RTApp.currentState.stops=null;RTApp.utils={};RTApp.views={};RTApp.dialogs={};RTApp.model={};RTApp.load=function(){console.log("RTApp.load >>");RTApp.router=new RTApp.Router();Backbone.history.start();var a=LocalStorageManager.get(RTApp.C_LOCALSTORAGE_CLIENT_ID);if(window.location.hash==""&&a&&a.id){RTApp.router.navigate("map/"+a.id,{trigger:true})}};RTApp.goToSelectAgency=function(){window.location.href="#"};RTApp.Router=Backbone.Router.extend({clientId:false,routeId:false,routes:{"":"landing","map/:clientId":"map","map/:clientId/:routeId":"map","news/:clientId":"news","arrivals/:clientId":"arrivals","arrivals/:clientId/:routeId":"arrivals","routes/:clientId":"selectRoute","routes/:clientId/:online":"selectRoute","routeSchedule/:clientId/:routeId":"routeSchedule","options/:clientId":"options","404":"pageNotFound"},landing:function(){if(!RTApp.views.selectAgencyView){RTApp.views.selectAgencyView=new RTApp.views.SelectAgencyView()}RTApp.views.selectAgencyView.load();this._showView(RTApp.views.selectAgencyView,true)},pageNotFound:function(){},map:function(a,b){this.clientId=a;this.routeId=b;if(!RTApp.views.mapView){RTApp.views.mapView=new RTApp.views.MapView()}RTApp.views.mapView.load(a,b);this._showView(RTApp.views.mapView)},selectRoute:function(a,b){this.clientId=a;if(!RTApp.views.selectRouteView){RTApp.views.selectRouteView=new RTApp.views.SelectRouteView()}RTApp.views.selectRouteView.load(a,b);this._showView(RTApp.views.selectRouteView)},news:function(a){this.clientId=a;if(!RTApp.views.newsView){RTApp.views.newsView=new RTApp.views.NewsView()}RTApp.views.newsView.load(a);this._showView(RTApp.views.newsView)},arrivals:function(a,b){this.clientId=a;this.routeId=b;if(!RTApp.views.arrivalsView){RTApp.views.arrivalsView=new RTApp.views.ArrivalsView()}RTApp.views.arrivalsView.load(a,b);this._showView(RTApp.views.arrivalsView)},options:function(a){if(!RTApp.views.optionsView){RTApp.views.optionsView=new RTApp.views.OptionsView()}RTApp.setTitle("More");RTApp.views.optionsView.load(a);this._showView(RTApp.views.optionsView)},routeSchedule:function(a,b){if(!RTApp.views.routeSchedule){RTApp.views.routeSchedule=new RTApp.views.RouteSchedule()}RTApp.views.routeSchedule.load(a,b);this._showView(RTApp.views.routeSchedule)},_showView:function(a){if(this.currentView&&this.currentView.onBeforeHide){this.currentView.onBeforeHide()}if(a.onBeforeShow){a.onBeforeShow()}this.currentView=a;$(".page").hide();this.currentView.$el.show();if(this.currentView.focus){this.currentView.focus()}this.manageMenu();setTimeout(function(){},100)},manageMenu:function(){var a=RTApp.currentState.client?RTApp.currentState.client.get("id"):this.clientId;var e=RTApp.currentState.route?RTApp.currentState.route.get("id"):this.routeId;var c="#map/"+a;var b="#arrivals/"+a;if(e){c+="/"+e;b+="/"+e}$("#menu-map").attr("href",c);$("#backToMap").attr("href","#map/"+a);$("#selectRouteAll").attr("href","#routes/"+a);$("#selectRouteOnline").attr("href","#routes/"+a+"/online");$("#menu-arrivals").attr("href",b);$("#menu-routes").attr("href","#routes/"+a+"/online");$("#menu-news").attr("href","#news/"+a);$("#menu-options").attr("href","#options/"+a);var d=window.location.hash.match(/^#([a-zA-Z]+)(\/)?.*/);if(d&&d[1]){$("#footer-nav a").removeClass("ui-btn-active");$("#menu-"+d[1]).addClass("ui-btn-active");$("#footer").show()}else{$("#footer").hide()}},changeView:function(a){console.log("changeView to "+a);$(a).fadeIn();if(this.$currentView){this.$currentView.fadeOut("fast",function(){$.mobile.hidePageLoadingMsg()})}this.$currentView=$(a)}});RTApp.setTitle=function(a){$("#header h1").html(a)};RTApp.fixHeight=function(c){var b=$("#header").height();var a=$("#footer").height()||0;var d=$(window).height()-b-a-5;if(d<310){d=310}c.css({minHeight:d})};RTApp.views.MapView=Backbone.View.extend({el:"#map",map:null,initialize:function(){console.log("MapView - initialize");RTApp.fixHeight(this.$el);$("#myLocation").click(function(){RTApp.views.mapView.goToMyLocation();return false});_.bindAll(this,"drawBuses")},mapIsLoaded:false,loadMap:function(a,c){if(this.mapIsLoaded){setTimeout(function(){google.maps.event.trigger(map,"resize");RTApp.views.mapView.map.panTo(a);if(c){RTApp.views.mapView.map.setZoom(c)}$.mobile.hidePageLoadingMsg()},1000);return}var b={zoom:(!c||c<12)?c:12,center:a,mapTypeId:google.maps.MapTypeId.ROADMAP,trackMarkers:true,streetViewControl:false,scrollwheel:false,zoomControl:true,scaleControl:false,rotateControl:false,panControl:false,overviewMapControl:false,noClear:true,keyboardShortcuts:false,mapTypeControl:false,draggable:true,mapMaker:false,disableDoubleClickZoom:false,styles:RTApp.mapStyles};this.map=new google.maps.Map(document.getElementById("map"),b);this.mapIsLoaded=true;$.mobile.hidePageLoadingMsg()},goToMyLocation:function(){if(!RTApp.LocationTrackerPID){var a={maximumAge:60000,timeout:15000,enableHighAccuracy:true};RTApp.LocationTrackerPID=navigator.geolocation.watchPosition(this.onGetLocation,this.onNoLocation,a)}},onGetLocation:function(a){if(!RTApp.views.mapView||!RTApp.views.mapView.map){return}var c=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);RTApp.views.mapView.map.setCenter(c);if(RTApp.userMarker){RTApp.userMarker.setPosition(c)}else{var b=new google.maps.MarkerImage("resources/images/icon_pin.png",new google.maps.Size(48,48),new google.maps.Point(0,0),new google.maps.Point(24,48),new google.maps.Size(48,48));RTApp.userMarker=new google.maps.Marker({position:c,title:"You",content:"You",map:RTApp.views.mapView.map,animation:google.maps.Animation.DROP,icon:b,zIndex:10})}if(RTApp.LocationTrackerPID){navigator.geolocation.clearWatch(RTApp.LocationTrackerPID)}RTApp.LocationTrackerPID=null},onNoLocation:function(a){if(a.code==1){alert("Please, enable location tracking")}else{if(a.code==2){alert("Please, enable location tracking")}}},onBeforeShow:function(){RTApp.model.buses.bind("reset",this.drawBuses,this);$("body").bind("scrollstart",function(a){a.preventDefault()});$("#myLocation").show()},onBeforeHide:function(){this.stopBusPolling();$(window.document.body).unbind("scrollstart");RTApp.model.buses.unbind("reset",this.drawBuses,this);if(RTApp.dialogs.common){RTApp.dialogs.common.close()}if(RTApp.dialogs.routeInfo){RTApp.dialogs.routeInfo.close()}$("#backToMap").hide();$("#myLocation").hide()},load:function(a,b){console.log("load map "+a+" : "+b);$.mobile.showPageLoadingMsg();RTApp.model.clients.fetch({success:function(){RTApp.currentState.client=RTApp.model.clients.get(a);if(!RTApp.currentState.client){return RTApp.goToSelectAgency()}RTApp.model.fetchClientsSettings(RTApp.currentState.client.get("WebAddress"),"showstoplabel");RTApp.setTitle(RTApp.currentState.client.get("Name"));Canon.charge(2,function(){RTApp.views.mapView.render();RTApp.views.mapView.drawBuses();$(".mask").hide();RTApp.views.mapView.startBusPolling();RTApp.router.manageMenu();setTimeout(function(){if(b){$("#myLocation").hide();$("#backToMap").show()}else{$("#backToMap").hide()}},1000)});RTApp.model.routes.fetch(RTApp.currentState.client.get("WebAddress"),{success:function(){var d;var e;if(b){RTApp.currentState.route=RTApp.model.routes.get(b);d=new google.maps.LatLng(RTApp.currentState.route.get("MapLatitude"),RTApp.currentState.route.get("MapLongitude"));e=RTApp.currentState.route.get("MapZoom");var c=RTApp.currentState.route.get("MapLineColor");color2="#"+hexDarker(c,30);RTApp.setTitle('<span style="background-color: '+c+";  background-image: -webkit-linear-gradient("+c+", "+color2+');" class="header-label">&nbsp;</span>&nbsp;'+RTApp.currentState.route.get("Description"))}else{firstRoute=RTApp.model.routes.first();d=new google.maps.LatLng(firstRoute.get("MapLatitude"),firstRoute.get("MapLongitude"));e=firstRoute.get("MapZoom");RTApp.currentState.route=false}RTApp.views.mapView.loadMap(d,e);setTimeout(function(){Canon.tick()},100)}});RTApp.model.stops.fetch(RTApp.currentState.client.get("WebAddress"),{success:function(){var c=RTApp.model.stops.toJSON();RTApp.currentState.stops=[];if(b){for(var d=0;d<c.length;d++){if(c[d].RouteID==b){RTApp.currentState.stops.push(c[d])}}}else{RTApp.currentState.stops=false}Canon.tick()}})}})},render:function(){_.each(this.stopMarkers,function(g,h){g.setMap(null)},this);if(RTApp.currentState.route&&RTApp.currentState.stops){var d=RTApp.model.getClientsSettings(RTApp.currentState.client.get("WebAddress"),"showstoplabel");var b;if(!d){b=false}else{if(d.SettingValue=="true"){b=true}else{if(d.SettingValue=="false"){b=false}}}var f=[];for(var a=0;a<RTApp.currentState.stops.length;a++){var c=RTApp.currentState.stops[a];this.setStopMarkerOnMap(c,b);for(var e=0;e<c.MapPoints.length;e++){f.push(new google.maps.LatLng(c.MapPoints[e].Latitude,c.MapPoints[e].Longitude))}}if(RTApp.currentState.route.get("HideRouteLine")===undefined||!RTApp.currentState.route.get("HideRouteLine")){if(!this.busPath){this.busPath=new google.maps.Polyline({path:[],strokeColor:RTApp.currentState.route.get("MapLineColor"),strokeOpacity:0.6,strokeWeight:6,zIndex:10,clickable:false})}else{this.busPath.setOptions({strokeColor:RTApp.currentState.route.get("MapLineColor")})}this.busPath.setPath(f);this.busPath.setMap(this.map)}else{if(this.busPath){this.busPath.setMap(null);this.busPath=null}}}else{if(this.busPath){this.busPath.setMap(null);this.busPath=null}}},setStopMarkerOnMap:function(c,d){var b="STOP_"+c.RouteID+"_"+c.RouteStopID;var a=new RouteStopMarker(c,this.map,d);google.maps.event.addListener(a,"click",function(e){RTApp.dialogs.common.showStop(a.stop_)});this.stopMarkers[b]=a},setBusMarkerOnMap:function(a){},busMarkers:{},stopMarkers:{},routePath:null,animateMarker:function(b,a){b.updateBus(a);b.show()},drawBuses:function(){if(RTApp.model.buses.length==0){}_.each(this.busMarkers,function(a,c){var b=true;RTApp.model.buses.forEach(function(d){var e="BUS_"+d.get("VehicleID");if(e==c){b=false}},this);if(b){a.hide()}},this);RTApp.model.buses.forEach(function(b){var c="BUS_"+b.get("VehicleID");var a=this.busMarkers[c];if(RTApp.currentState.route&&b.get("RouteID")!=RTApp.currentState.route.get("RouteID")){if(a){a.hide()}return}if(a){this.animateMarker(this.busMarkers[c],b)}else{a=new BusMarker(b,this.map);a.id=c;google.maps.event.addListener(a,"click",function(d){RTApp.dialogs.common.showBus(a.bus_)});this.busMarkers[c]=a}},this)},startBusPolling:function(){if(!this.busPollingIntervalID){var a=function(){RTApp.model.buses.fetch(RTApp.currentState.client.get("WebAddress"))};a();this.busPollingIntervalID=setInterval(a,RTApp.cfg.BUS_REFRESH_TIME)}},stopBusPolling:function(){clearInterval(this.busPollingIntervalID);this.busPollingIntervalID=null}});RTApp.views.OptionsView=Backbone.View.extend({el:"#options",initialize:function(){console.log("OptionsView - initialize");this.render()},onBeforeShow:function(){RTApp.fixHeight(this.$el)},load:function(a){$.mobile.showPageLoadingMsg();$("#goToGuide").hide();RTApp.model.clients.fetch({success:function(){RTApp.currentState.client=RTApp.model.clients.get(a);if(!RTApp.currentState.client){return RTApp.goToSelectAgency()}RTApp.model.fetchClientsSettings(RTApp.currentState.client.get("WebAddress"),"userguide",function(b){if(b&&b.SettingValue){$("#goToGuide").attr("href",b.SettingValue).show()}else{$("#goToGuide").hide()}});RTApp.model.fetchClientsSettings(RTApp.currentState.client.get("WebAddress"),"feedbackemail",function(b){if(b&&b.SettingValue){$("#appFeedback").attr("href","mailto:"+b.SettingValue).show()}else{$("#appFeedback").hide()}});RTApp.router.manageMenu();$("#goToWebSite").attr("href","http://"+RTApp.currentState.client.get("WebAddress"));RTApp.views.optionsView.render()}})},render:function(){console.log("OptionsView - render");$.mobile.hidePageLoadingMsg()},clearCache:function(){LocalStorageManager.clear()},events:{"click #clearCache":"clearCache"}});RTApp.views.SelectAgencyView=Backbone.View.extend({el:"#selectAgency",template:"<% var lastLetter = 0; _.each(clients, function(client) { var clientLetter = client.get('Name').toUpperCase()[0] %> <% if (lastLetter != clientLetter) { lastLetter = clientLetter; %><li data-role='list-divider'><%= clientLetter %></li><% } %><li><span class='client-li' style='background-color: #<%= client.get('HexColor') %>;'></span><a rel='<%= client.get('ClientID') %>' href='#map/<%= client.get('ClientID') %>'><%= client.get('Name') %></a></li> <% }); %>",initialize:function(){console.log("SelectAgency - initialize");this.model=RTApp.model.clients;_.bindAll(this,"render")},onBeforeShow:function(){},onBeforeHide:function(){},load:function(){RTApp.setTitle("Select Agency");this.model.fetch({success:function(){RTApp.views.selectAgencyView.render()}})},render:function(){console.log("SelectAgency - render");var a=this.model.sortBy(function(c){return c.get("Name").toLowerCase()});var b=_.template(this.template,{clients:a});$("ul",this.$el).html(b).listview("refresh");$.mobile.hidePageLoadingMsg();return this},events:{"click a":"selectClient"},selectClient:function(b){var a={id:$(b.target).attr("rel")};LocalStorageManager.set(RTApp.C_LOCALSTORAGE_CLIENT_ID,a)}});RTApp.views.SelectRouteView=Backbone.View.extend({el:"#selectRoute",template:"<% _.each(routes, function(route) { %> <li><span class='bus-li' style='background-color: <%= route.MapLineColor %>'></span><a rel='<%= route.RouteID %>' href='#map/<%= client.id %>/<%= route.RouteID %>'><%= route.Description %> </a> <% if (route.StopTimesPDFLink && route.StopTimesPDFLink != '') { %> <a data-icon='info' class='pdf' rel='<%= route.StopTimesPDFLink %>'></a><% } %></li> <% }); %>",initialize:function(){console.log("SelectRouteView - initialize");this.model=RTApp.model.routes;_.bindAll(this,"render")},goToPdf:function(b){var a=$(b.currentTarget).attr("rel");LocalStorageManager.set("url_of_image",{url:a});window.location.href="img.html"},events:{"click .pdf":"goToPdf"},onBeforeShow:function(){RTApp.fixHeight(this.$el)},onBeforeHide:function(){},onlineMode:false,onlineRoutesIds:[],load:function(a,b){$.mobile.showPageLoadingMsg();RTApp.model.clients.fetch({success:function(){RTApp.currentState.client=RTApp.model.clients.get(a);if(!RTApp.currentState.client){return RTApp.goToSelectAgency()}RTApp.model.routes.fetch(RTApp.currentState.client.get("WebAddress"),{success:function(){RTApp.views.selectRouteView.onlineMode=b;if(b){RTApp.model.estimates.fetch(RTApp.currentState.client.get("WebAddress"),null,{success:function(d){var c=d.toJSON();RTApp.views.selectRouteView.onlineRoutesIds={};setTimeout(function(){$.mobile.hidePageLoadingMsg();var f=0;for(var e in RTApp.views.selectRouteView.onlineRoutesIds){if(RTApp.views.selectRouteView.onlineRoutesIds.hasOwnProperty(e)){f++}}if(f==0){RTApp.flashMessage("No active routes");RTApp.router.navigate("routes/"+a,{trigger:true})}},3000);RTApp.model.fetchRouteSchedules(RTApp.currentState.client.get("WebAddress"),function(p){var o=new Date();var h=o.getTimezoneOffset();var m=h/60;console.log(o.getTime());for(var l in p){var r=p[l];console.log(r);var v=r.StartTime.match(/Date\((\d+)([-+])(\d{2})(\d{2})\)/);var e=r.EndTime.match(/Date\((\d+)([-+])(\d{2})(\d{2})\)/);if(v.length!=5||e.length!=5){continue}if(v[3][0]=="0"){v[3]=v[3].substring(1)}var u=(parseInt(v[3]));if(v[2]=="-"){u*=-1}var t=parseInt(v[1]);var k=parseInt(e[1]);var g=new Date(t);var j=new Date(k);var q=g.getHours()*60+g.getMinutes()+u*60+m*60;var f=j.getHours()*60+j.getMinutes()+u*60+m*60;if(f<=q){f+=24*60}var s=o.getHours()*60+o.getMinutes()+u*60+m*60;if(s>=q&&s<=f){console.log("okkey ",r.RouteID);RTApp.views.selectRouteView.onlineRoutesIds[r.RouteID]=true}if((s+24*60)>=q&&(s+24*60)<=f){RTApp.views.selectRouteView.onlineRoutesIds[r.RouteID]=true}console.log(q,s,f);console.log(q,s+24*60,f)}RTApp.views.selectRouteView.render();console.log("online ",RTApp.views.selectRouteView.onlineRoutesIds)})}});$("#selectRouteOnline").addClass("ui-btn-active");$("#selectRouteAll").removeClass("ui-btn-active")}else{$("#selectRouteOnline").removeClass("ui-btn-active");$("#selectRouteAll").addClass("ui-btn-active");RTApp.views.selectRouteView.render()}}})}})},render:function(){console.log("SelectRouteView - render");RTApp.setTitle("Select route");if(RTApp.currentState.client){var e="";if(!this.onlineMode){e+='<li><a href="#map/'+RTApp.currentState.client.get("ClientID")+'">Show all vehicles on route</a></li>'}var b=this.model.toJSON();var a=false;for(var d in b){var c=b[d];if(c.IsVisibleOnMap===undefined){c.IsVisibleOnMap=true}if(!c.IsVisibleOnMap||(this.onlineMode&&this.onlineRoutesIds[c.RouteID]===undefined)){delete b[d];continue}a=true}if(this.onlineMode&&!a){e+='<li class="tac">No Active Routes</li>'}else{e+=_.template(this.template,{routes:b,client:RTApp.currentState.client})}$("#selectRouteList",this.$el).html(e).listview("refresh");$.mobile.hidePageLoadingMsg()}return this}});RTApp.views.ArrivalsView=Backbone.View.extend({el:"#arrivals",template:"<% _.each(stops, function(stop) { %><li><%= stop.Description %></li><% }); %>",initialize:function(){console.log("ArrivalsView - initialize");this.model=RTApp.model.estimates;_.bindAll(this,"render")},onBeforeShow:function(){RTApp.fixHeight(this.$el);this.stopEstimatesPolling()},onBeforeHide:function(){},load:function(a,b){$.mobile.showPageLoadingMsg();RTApp.model.clients.fetch({success:function(){RTApp.currentState.client=RTApp.model.clients.get(a);if(!RTApp.currentState.client){return RTApp.goToSelectAgency()}if(b){RTApp.model.estimates.fetch(RTApp.currentState.client.get("WebAddress"),b,{success:function(){RTApp.views.arrivalsView.render()}})}else{RTApp.views.arrivalsView.selectRouteFirst()}}})},selectRouteFirst:function(){console.log("ArrivalsView - select selectRouteFirst");RTApp.setTitle("Arrivals");$("ul",this.$el).html("").listview("refresh");$.mobile.hidePageLoadingMsg();$("#goToSelectRoute").show()},render:function(){RTApp.setTitle("Arrivals");console.log("ArrivalsView - render");if(RTApp.currentState.client){var a="";var b=this.model.toJSON();if(b.length>0&&b[0].RouteStops&&b[0].RouteStops.length>0){a+=_.template($("#estimatesTemplate").html(),{stops:this.model.toJSON()[0].RouteStops,client:RTApp.currentState.client});$("ul",this.$el).html(a).listview("refresh")}else{$("ul",this.$el).html("<li class='tac'>No times available</li>").listview("refresh")}$("#goToSelectRoute").hide()}$.mobile.hidePageLoadingMsg();return this},startEstimatesPolling:function(){if(!this.estimatesPollingIntervalID){var a=function(){RTApp.model.estimates.fetch(RTApp.currentState.client.get("WebAddress"))};a();this.estimatesPollingIntervalID=setInterval(a,RTApp.cfg.BUS_REFRESH_TIME)}},stopEstimatesPolling:function(){clearInterval(this.estimatesPollingIntervalID);this.estimatesPollingIntervalID=null},events:{"click #goToSelectRoute":function(){window.location.href="#routes/"+RTApp.currentState.client.get("ClientID");return false}}});RTApp.views.RouteSchedule=Backbone.View.extend({el:"#routeSchedule",initialize:function(){console.log("RouteSchedule - initialize")},load:function(a,b){$.mobile.showPageLoadingMsg();RTApp.model.clients.fetch({success:function(){RTApp.currentState.client=RTApp.model.clients.get(a);if(!RTApp.currentState.client){return RTApp.goToSelectAgency()}RTApp.model.routes.fetch(RTApp.currentState.client.get("WebAddress"),{success:function(){RTApp.views.routeSchedule.model=RTApp.model.routes.get(b);RTApp.views.routeSchedule.render()}})}})},imageZoom:100,render:function(){var a=null;$("#zoomContainer").bind("touchstart",function(b){if(a==null){a=b.originalEvent.touches[0]||b.originalEvent.changedTouches[0]}});$("#zoomContainer").bind("touchmove",function(g){g.preventDefault();var i=g.originalEvent.touches[0]||g.originalEvent.changedTouches[0];var d=a.pageX-i.pageX;var b=a.pageY-i.pageY;var h=parseInt($("#zoomContainer img").css("margin-left").replace("px",""));var c=parseInt($("#zoomContainer img").css("margin-top").replace("px",""));$("#zoomContainer img").css("marginLeft",h-d);$("#zoomContainer img").css("marginTop",c-b);var f=$("<i>").html((h-d)+","+(c-b)+"; ");a=i});$("#zoomContainer").bind("touchend",function(b){a=null});console.log("RouteSchedule - render");RTApp.setTitle(this.model.get("Description"));$("img",this.$el).attr("src",this.model.get("StopTimesPDFLink")).attr("width",this.imageZoom+"%");$.mobile.hidePageLoadingMsg();return this},events:{"click #zoomin":"zoomin","click #zoomout":"zoomout"},zoomin:function(){this.imageZoom+=33;$("img",this.$el).attr("width",this.imageZoom+"%")},zoomout:function(){this.imageZoom-=33;$("img",this.$el).attr("width",this.imageZoom+"%")}});RTApp.views.NewsView=Backbone.View.extend({el:"#news",template:"<% _.each(twitts, function(twi) { %> <li><%= twi.text %><br/> <i class='twi-date'><%= twi.created_at.substring(0, twi.created_at.length - 11) %></i></li> <% }); %>",initialize:function(){console.log("NewsView - initialize");this.model=RTApp.model.twitts;_.bindAll(this,"render")},onBeforeShow:function(){RTApp.fixHeight(this.$el)},onBeforeHide:function(){},load:function(a){RTApp.setTitle("Alerts");$.mobile.showPageLoadingMsg();RTApp.model.clients.fetch({success:function(){RTApp.currentState.client=RTApp.model.clients.get(a);if(!RTApp.currentState.client){return RTApp.goToSelectAgency()}RTApp.views.newsView.model.fetch(RTApp.currentState.client.get("TwitterTag"),1,{success:function(){RTApp.views.newsView.render()}})}})},render:function(){console.log("NewsView - render");var b=this.model.toJSON();console.log(b);if(b.length>0){var a=_.template(this.template,{twitts:b});$("ul",this.$el).html(a).listview("refresh")}else{$("ul",this.$el).html("<li class='tac'>No alerts</li>").listview("refresh")}$.mobile.hidePageLoadingMsg();return this},loadMore:function(){$.mobile.showPageLoadingMsg()},events:{"click .loadMore":"loadMore"}});Backbone.jsonpSync=function(c,b,a){a.timeout=10000;a.dataType="jsonp";a.error=function(){RTApp.flashMessage("Internet connection problem")};return Backbone.sync(c,b,a)};RTApp.flashMessage=function(a){$.mobile.hidePageLoadingMsg();$("#flashMessage").html(a).fadeIn(500,function(){setTimeout(function(){$("#flashMessage").fadeOut(500)},3000)})};RTApp.model.CachebleCollection=Backbone.Collection.extend({initialize:function(){if(!this.cacheKey){alert("Cache Key is not defined")}this.on("reset",function(c,a){var b=jQuery.isFunction(this.cacheKey)?this.cacheKey():this.cacheKey;if(!a.skipCacheWrite){console.log("write cache to localstorage for key "+b);LocalStorageManager.set(b,this.toJSON())}else{console.log("skip write cache to localstorage for key "+b)}})},fetch:function(b){var d=jQuery.isFunction(this.cacheKey)?this.cacheKey():this.cacheKey;console.log("look in localstorage by key "+d);var a=LocalStorageManager.get(d);if(a){console.log("got cahce!");var c=this.reset(a,{skipCacheWrite:true});if(b&&b.success){b.success()}return c}console.log("cahce miss");b||(b={});return Backbone.Collection.prototype.fetch.call(this,b)}});RTApp.model.Clients=RTApp.model.CachebleCollection.extend({cacheKey:RTApp.C_LOCALSTORAGE_CACHE_4_GET_CLIENTS,url:RTApp.cfg.urls.GET_CLIENTS_URL,sync:Backbone.jsonpSync,parse:function(a){for(var b in a){a[b].id=a[b].ClientID}return a}});RTApp.model.Routes=RTApp.model.CachebleCollection.extend({webAddress:"",cacheKey:function(){return RTApp.C_LOCALSTORAGE_CACHE_4_GET_ROUTES+this.webAddress},url:function(){return RTApp.cfg.urls.GET_ROUTES_URL.replace("{WebAddress}",this.webAddress)},sync:Backbone.jsonpSync,fetch:function(a,b){this.webAddress=a;b||(b={});b.beforeSend=function(c,d){d.url=d.url.replace("callback=","method=")};return RTApp.model.CachebleCollection.prototype.fetch.call(this,b)},parse:function(a){for(var b in a){a[b].id=a[b].RouteID}return a}});RTApp.model.Stops=RTApp.model.CachebleCollection.extend({webAddress:"",cacheKey:function(){return RTApp.C_LOCALSTORAGE_CACHE_4_GET_STOPS+this.webAddress},url:function(){return RTApp.cfg.urls.GET_STOPS_URL.replace("{WebAddress}",this.webAddress)},fetch:function(a,b){this.webAddress=a;b||(b={});b.beforeSend=function(c,d){d.url=d.url.replace("callback=","method=")};return RTApp.model.CachebleCollection.prototype.fetch.call(this,b)},sync:Backbone.jsonpSync,parse:function(a){for(var b in a){}return a}});RTApp.model.Buses=Backbone.Collection.extend({webAddress:"",url:function(){return RTApp.cfg.urls.GET_BUSES_URL.replace("{WebAddress}",this.webAddress)},fetch:function(a,b){this.webAddress=a;b||(b={});b.beforeSend=function(c,d){d.url=d.url.replace("callback=","method=")};return Backbone.Collection.prototype.fetch.call(this,b)},parse:function(a){for(var b in a){a[b].id=a[b].VehicleID}return a},sync:Backbone.jsonpSync});RTApp.model.Estimates=Backbone.Collection.extend({webAddress:"",url:function(){return RTApp.cfg.urls.GET_ESTIMATES_URL.replace("{WebAddress}",this.webAddress).replace("{RouteID}",this.routeId)},fetch:function(a,c,b){this.webAddress=a;this.routeId=c;b||(b={});b.beforeSend=function(d,e){e.url=e.url.replace("callback=","method=")};return Backbone.Collection.prototype.fetch.call(this,b)},sync:Backbone.jsonpSync,parse:function(b){if(b[0]&&b[0].RouteStops&&b[0].RouteStops.length>0){for(var a in b[0].RouteStops){var d=b[0].RouteStops[a];var f=d.Estimates;b[0].RouteStops[a].Estimates=[];for(var c in f){var e=f[c].VehicleID;if(f[c].OnRoute){b[0].RouteStops[a].Estimates[f[c].SecondsToStop]=f[c]}}}return b}}});RTApp.model.Twitts=Backbone.Collection.extend({tag:"",page:1,url:function(){var a=RTApp.cfg.urls.TWITTER_URL.replace("{q}",this.tag).replace("{page}",this.page).replace("{rpp}",RTApp.cfg.TWITTS_PER_PAGE);console.log("twitts url request",a);return a},fetch:function(a,c,b){this.tag=a;this.page=c;b||(b={});return Backbone.Collection.prototype.fetch.call(this,b)},sync:Backbone.jsonpSync,parse:function(a){return a}});var LocalStorageManager=new function(){function a(){return(typeof(localStorage)!="undefined")}return{set:function(c,b){if(!a()){return false}try{localStorage.setItem(c,JSON.stringify(b))}catch(d){}},get:function(b){if(!a()){return false}var c=localStorage.getItem(b);if(c){return JSON.parse(c)}return false},remove:function(b){if(!a()){return false}return localStorage.removeItem(b)},clear:function(){if(!a()){return false}localStorage.clear()}}};var Canon=new function(){var b;var a;return{charge:function(c,d){a=c;b=d},tick:function(){a--;if(a==0){b()}}}};RTApp.model.clients=new RTApp.model.Clients();RTApp.model.routes=new RTApp.model.Routes();RTApp.model.stops=new RTApp.model.Stops();RTApp.model.buses=new RTApp.model.Buses();RTApp.model.twitts=new RTApp.model.Twitts();RTApp.model.estimates=new RTApp.model.Estimates();RTApp.model.fetchClientsSettings=function(b,c,e){var d=RTApp.C_LOCALSTORAGE_CACHE_4_GET_CLIENT_SETTINGS+"_"+b+"_"+c;var a=LocalStorageManager.get(d);if(!a){$.ajax({url:RTApp.cfg.urls.GET_CLIENT_SETTINGS.replace("{WebAddress}",b),data:{SettingName:c},dataType:"jsonp",beforeSend:function(f,g){g.url=g.url.replace("callback=","method=")},}).done(function(f){if(f&&f[0]){LocalStorageManager.set(d,f[0]);if(e){e(f[0])}}else{if(e){e(null)}}})}else{if(e){e(a)}}};RTApp.model.getClientsSettings=function(a,b){var c=RTApp.C_LOCALSTORAGE_CACHE_4_GET_CLIENT_SETTINGS+"_"+a+"_"+b;return LocalStorageManager.get(c)};RTApp.model.fetchRouteSchedules=function(b,d){var c=RTApp.C_LOCALSTORAGE_CACHE_4_GET_ROUTE_SCHEDULES+"_"+b;var a=LocalStorageManager.get(c);if(!a){$.ajax({url:RTApp.cfg.urls.GET_ROUTE_SCHEDULES.replace("{WebAddress}",b),dataType:"jsonp",beforeSend:function(e,f){f.url=f.url.replace("callback=","method=")},}).done(function(e){if(e){LocalStorageManager.set(c,e);if(d){d(e)}}else{if(d){d(null)}}})}else{if(d){d(a)}}};function BusMarker(a,b){this.bus_=a;this.map_=b;this.div_=null;this.directionImage_=null;this.setMap(b)}BusMarker.prototype=new google.maps.OverlayView();BusMarker.prototype.updateBus=function(a){this.bus_=a;this.draw()};BusMarker.prototype.onAdd=function(){var d=document.createElement("DIV");d.className="busMarker";d.setAttribute("rel",this.bus_.get("VehicleID"));d.style.backgroundColor="red";var c=document.createElement("IMG");c.src="resources/images/markers/N.png";c.setAttribute("rel",this.bus_.get("VehicleID"));d.appendChild(c);this.div_=d;this.directionImage_=c;var a=this.getPanes();this.getPanes().floatPane.style.zIndex=4000;a.floatPane.appendChild(d);var b=this;google.maps.event.addDomListener(this.div_,"click",function(){google.maps.event.trigger(b,"click")})};BusMarker.prototype.draw=function(){var b=this.getProjection();var g=b.fromLatLngToDivPixel(new google.maps.LatLng(this.bus_.get("Latitude"),this.bus_.get("Longitude")));var f=this.div_;var e=this.directionImage_;f.style.left=(g.x-15)+"px";f.style.top=(g.y-15)+"px";if(this.bus_.get("GroundSpeed")>4){e.src="resources/images/markers/N.png";e.style["-webkit-transform"]="rotate("+this.bus_.get("Heading")+"deg)"}else{e.src="resources/images/markers/stop.png";e.style["-webkit-transform"]="rotate(0deg)"}var d="#ff0000";var a=RTApp.model.routes.get(this.bus_.get("RouteID"));if(a){d=a.get("MapLineColor")}var c=hexDarker(d,30);f.style["background-image"]="-webkit-gradient(linear, 0% 36%, 50% 100%, from("+d+"), to(#"+c+"))"};BusMarker.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_);this.div_=null};BusMarker.prototype.hide=function(){if(this.div_){this.div_.style.visibility="hidden"}};BusMarker.prototype.show=function(){if(this.div_){this.div_.style.visibility="visible"}};BusMarker.prototype.toggle=function(){if(this.div_){if(this.div_.style.visibility=="hidden"){this.show()}else{this.hide()}}};BusMarker.prototype.toggleDOM=function(){if(this.getMap()){this.setMap(null)}else{this.setMap(this.map_)}};function RouteStopMarker(a,c,b){this.stop_=a;this.map_=c;this.div_=null;this.showlabel_=b;this.setMap(c)}RouteStopMarker.prototype=new google.maps.OverlayView();RouteStopMarker.prototype.onAdd=function(){var e=document.createElement("DIV");e.className="stopMarker";e.setAttribute("rel",this.stop_.RouteStopID);var d=document.createElement("IMG");d.src="resources/images/markers/stop_marker.png";d.setAttribute("rel",this.stop_.RouteStopID);e.appendChild(d);var a=document.createElement("LABEL");a.innerHTML=this.stop_.Description;a.className="stopLabel";a.setAttribute("rel",this.stop_.RouteStopID);if(this.showlabel_){e.appendChild(a)}this.div_=e;this.label_=a;var b=this.getPanes();this.getPanes().floatPane.style.zIndex=3000;b.floatPane.appendChild(e);var c=this;google.maps.event.addDomListener(this.div_,"click",function(){google.maps.event.trigger(c,"click")})};RouteStopMarker.prototype.draw=function(){var a=this.getProjection();var c=a.fromLatLngToDivPixel(new google.maps.LatLng(this.stop_.Latitude,this.stop_.Longitude));var b=this.div_;b.style.left=(c.x-8)+"px";b.style.top=(c.y-8)+"px"};RouteStopMarker.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_);this.div_=null};RouteStopMarker.prototype.hide=function(){if(this.div_){this.div_.style.visibility="hidden"}};RouteStopMarker.prototype.show=function(){if(this.div_){this.div_.style.visibility="visible"}};RouteStopMarker.prototype.toggle=function(){if(this.div_){if(this.div_.style.visibility=="hidden"){this.show()}else{this.hide()}}};RouteStopMarker.prototype.toggleDOM=function(){if(this.getMap()){this.setMap(null)}else{this.setMap(this.map_)}};Dialog=function(c){var a;var b=$(c);$(".close",b).click(function(){a.close();return false});return a={show:function(e,d){if(e){$("h1",b).html(e)}$(".text-content",b).html("");if(d&&(typeof d=="string")){$(".text-content",b).html(d)}if(d&&(typeof d=="object")){$(".text-content",b).append(d)}b.css({top:document.body.scrollTop+30});b.show()},close:function(){b.hide()},setPrimaryAction:function(f,e,d){$(".primary-action",b).attr("href",f).show();$(".ui-btn-text",$(".primary-action",b)).html(e);if(d){$(".primary-action",b).click(d)}},setSecondaryAction:function(f,e,d){$(".secondary-action",b).attr("href",f).show();$(".ui-btn-text",$(".secondary-action",b)).html(e);if(d){$(".secondary-action",b).click(d)}},hideActions:function(){$(".secondary-action",b).hide();$(".primary-action",b).hide()},showBus:function(d){this.hideActions();var e=RTApp.model.routes.get(d.get("RouteID"));$("h1",b).html(e.get("Description")+" Route - #"+d.get("Name"));$(".text-content",b).html("loading...");RTApp.model.estimates.fetch(RTApp.currentState.client.get("WebAddress"),d.get("RouteID"),{success:function(p){var t=p.toJSON();var o=1000000;var s=null;var n=1000000;var m=null;if(t[0]&&t[0].RouteStops&&t[0].RouteStops.length>0){for(var l in t[0].RouteStops){var r=t[0].RouteStops[l];for(var k in r.Estimates){var q=r.Estimates[k];if(q.VehicleID==d.get("VehicleID")&&q.OnRoute&&q.SecondsToStop<o){n=o;m=s;s=r;o=q.SecondsToStop}}}}if(s){var h=Math.round(o/60);var g="";if(h!=0){g=s.Description+" "+h+" min"}else{g="Arriving at "+s.Description}if(m){g+="<br/>";var h=Math.round(n/60);if(h!=0){g+=m.Description+" "+h+" min"}else{g+="Arriving at "+m.Description}}$(".text-content",b).html(g);if(!RTApp.currentState.route||RTApp.currentState.route.get("RouteID")!=d.get("RouteID")){RTApp.dialogs.common.setSecondaryAction("#map/"+RTApp.currentState.client.get("id")+"/"+d.get("RouteID"),"Show route on map")}}else{$(".text-content",b).html("No times available")}}});var f=RTApp.cfg.urls.GET_ROUTES_URL.replace("{WebAddress}",RTApp.currentState.client.get("WebAddress"));$.ajax({url:f,data:{RouteID:d.get("RouteID")},dataType:"jsonp",beforeSend:function(g,h){h.url=h.url.replace("callback=","method=")}}).done(function(g){console.log(g);if(g&&g[0]&&g[0].StopTimesPDFLink){RTApp.dialogs.common.setPrimaryAction("img.html","View Schedule",function(){LocalStorageManager.set("url_of_image",{url:g[0].StopTimesPDFLink});window.location.href="img.html"})}});this.show()},showStop:function(d){this.hideActions();$("h1",b).html(d.Description);$(".text-content",b).html("loading...");RTApp.model.estimates.fetch(RTApp.currentState.client.get("WebAddress"),d.RouteID,{success:function(m){var e=m.toJSON();var g="";if(e[0]&&e[0].RouteStops&&e[0].RouteStops.length>0){for(var l in e[0].RouteStops){var f=e[0].RouteStops[l];if(d.RouteStopID==f.RouteStopID){for(var h in f.Estimates){var n=f.Estimates[h];if(n.OnRoute){var k=Math.round(n.SecondsToStop/60);if(k==0){g+="now, "}else{g+=k+" min, "}}}if(g!=""){g=g.substring(0,g.length-2)}}}}if(g!=""){if(g=="now"){$(".text-content",b).html("Now Arriving")}else{$(".text-content",b).html("Next arrival "+g)}}else{$(".text-content",b).html("No buses on route")}}});this.show()}}};function hexDarker(g,b){if(g[0]=="#"){g=g.substring(1)}var d="";function f(i){return i.toString(16)}function h(i){return parseInt(i,16)}var j=[];j.push(h(g.substring(0,2)));j.push(h(g.substring(2,4)));j.push(h(g.substring(4,6)));for(var e=0;e<j.length;e++){var c=j[e];var a=c/100;a=Math.round(a*b);$new_decimal=c-a;$new_hex_component=f($new_decimal);if($new_hex_component.length<2){$new_hex_component="0"+$new_hex_component}d+=$new_hex_component}return d}RTApp.mapStyles=[{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"administrative.country",stylers:[{visibility:"off"}]},{featureType:"administrative.province",stylers:[{visibility:"off"}]},{featureType:"administrative.locality",stylers:[{visibility:"off"}]},{featureType:"administrative.neighborhood",stylers:[{visibility:"off"}]},{featureType:"water",stylers:[{visibility:"simplified"}]},{featureType:"landscape",stylers:[{visibility:"off"}]},{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]},{featureType:"water",stylers:[{visibility:"simplified"}]},{}];